import pefile
from collections import defaultdict
import os
import csv

def main():
    imports = defaultdict(int)
    functions = defaultdict(int)
    import_file = open('outputs/imports.csv', 'w')
    function_file = open('outputs/functions.csv', 'w')
    problems_file = open('outputs/problems.txt', 'w')

    writer_import  = csv.writer(import_file, delimiter=',')
    writer_function  = csv.writer(function_file, delimiter=',')

    files = os.listdir('malware/train')
    l = len(files)
    counter = 1
    for file in files:
        print(f'Processing {counter}/{l}')
        counter += 1
        try:
            pe = pefile.PE('malware/train/'+file, fast_load = True)
            pe.parse_data_directories()
            for entry in pe.DIRECTORY_ENTRY_IMPORT:
                try:
                    imports[f'{entry.dll.decode().lower()}'] += 1
                except:
                    pass
                for func in entry.imports:
                    try:
                        functions[f'{entry.dll.decode().lower()}/{func.name.decode().lower()}'] += 1 
                    except:
                        pass
        except:
            problems_file.write(f'{file}\n')
    
    for entry in functions:
        writer_function.writerow([entry, functions[entry]])
    for dll in imports:
        writer_import.writerow([dll, imports[dll]])

    import_file.close()
    function_file.close() 

if __name__ == '__main__':
    main()