/*

Filename: validate_files.c
Function: given a list of filenames, check whether each:
1. is a valid filename
2. is a PE file
3. is 32-bit or 64-bit

*/

#include <stdio.h>
#include <string.h>
#include <ctype.h>


const char *delim = (char *)'\\';

int main(int argc, char *argv[]) {
    FILE *fp;
    char buf[BUFSIZ];
    int ch;
    int capture = 0;

    for(int i = 1; i < argc; i++) {
        fp = fopen(argv[i], "r");
        if(!fp) {
            printf("%s is not a valid filename.\n", argv[i]);
            continue;
        }

        fgets(buf, sizeof(buf), fp);
        
        if(buf[0] == 'M' && buf[1] == 'Z') {
            printf("%s is a PE file", argv[i]);
            while((ch = fgetc(fp)) != EOF) {
                if(isprint(ch)) {
                    if(capture == 1) {
                        if(ch == 'L') {
                            printf(" and is 32-bit.\n");
                            capture = 2;
                            break;
                        }
                        else if(ch == 'd') {
                            printf(" and is 64-bit.\n");
                            capture = 2;
                            break;
                        }
                        else {
                            capture = 0;
                        }
                    }
                    if(ch == 'P') {
                        ch = fgetc(fp);
                        if(!ch) {
                            break;
                        }
                        else {
                            if(isprint(ch) && ch == 'E') {
                                capture = 1;
                            }
                        }
                    }
                }
            }
            if(capture < 2) {
                printf(".\nCould not determine the bitness of the PE file.\n");
            }
        }
        else {
            printf("%s is not a PE file.", argv[i]);            
        }
        
        fclose(fp);
    }

    return 0;
}