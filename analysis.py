import sys
import os
import pefile

def main():
    file = sys.argv[1]

    # Read Machine Code and Determine PE
    f = open(file, "rb")
    header = f.read(2).decode()
    if header != 'MZ':
        print('File is not PE...')
        return

    # Determine if PE is 32 or 64 bit
    found = False
    for line in f:
        line = str(line)
        if 'PE' in line:
            for char in line[line.find('PE')+2:]:
                if char == 'L':
                    print('32 bit PE File')
                    found = True
                    break
                elif char == 'd':
                    print('64 bit PE File')
                    found = True
                    break
            if not found:
                print('PE File of Unknown Architecture')
            break
    f.close()

    # Get IAT of File
    iat = open('iat.txt', 'w')
    pe = pefile.PE(file, fast_load = True)
    pe.parse_data_directories()
    for entry in pe.DIRECTORY_ENTRY_IMPORT:
        iat.write(f'{entry.dll.decode()}\n')
        for func in entry.imports:
            iat.write(f'\t {hex(func.address)}, {func.name.decode()}\n')

    print('IAT Loaded Into ./iat.txt')


if __name__ == '__main__':
    main()