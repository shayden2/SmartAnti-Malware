from cProfile import label
import os
import csv
import json
from xml.dom.pulldom import default_bufsize
from joblib import load
import pefile
import vt
import hashlib
import warnings
import pickle
from itertools import chain, repeat, islice
from collections import defaultdict
from sklearn.metrics import accuracy_score

def main():
    files = os.listdir('../malware/test')
    w = open('results.txt', 'w')
    counter = 1
    total = len(files)
    for file in files:
        print(f'Binary: {counter}/{total}')
        counter += 1
        try:
            with open(f'../malware/test/{file}', 'rb') as f:
                    data = f.read()
                    data = list(data)
                    maxX = 200000
                    if len(data) > maxX:
                        input = data[:maxX]
                    else:
                        data = islice(chain(data, repeat(int(0))), maxX)
                        input = list(data)
        except:
            w.write(f'{file}:Blacklist\n')

        # Disables a "Version Depreciation User Warning" that we could not figure out how to fix...
        with warnings.catch_warnings():
            warnings.simplefilter("ignore")
            RFmodel = pickle.load(open('RFC.sav', 'rb'))

        w.write(f'{file}:{RFmodel.predict([input])[0]}\n')

def main2():
    with open('results.txt', 'r') as f:
        for number, line in enumerate(f):
            line = line.rstrip().split(':')
            print(f'{line[0]}:{line[1]}')
if __name__ == '__main__':
    main()